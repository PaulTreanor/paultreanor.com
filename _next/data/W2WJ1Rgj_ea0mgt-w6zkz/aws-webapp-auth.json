{"pageProps":{"postData":{"id":"aws-webapp-auth","contentHtml":"<h1>AWS Cognito and Amplify auth for React apps (without the Amplify CLI)</h1>\n<p>The Amplify frontend library is great for auth, but the Amplify docs don't make it very obvious how to use it without the slightly clunky Amplify CLI. Here are my notes on provisioning a Cognito userpool with AWS SAM and using it with the aws-amplify npm library to add auth in a webapp.</p>\n<h2>Provisioning a Cognito userpool and userpool client in AWS SAM</h2>\n<p>The Cognito userpool and userpool client are the actual backend infrastructure that manages user accounts. You can think of a userpool as a database for accounts. Here's an <a href=\"https://aws.amazon.com/serverless/sam/\">AWS SAM</a> template.yaml that can provision these resources:</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">AWSTemplateFormatVersion:</span> <span class=\"hljs-string\">'2010-09-09'</span>\n<span class=\"hljs-attr\">Transform:</span> <span class=\"hljs-string\">AWS::Serverless-2016-10-31</span>\n<span class=\"hljs-attr\">Description:</span> <span class=\"hljs-string\">>\n  Cognito resources for webapp authorisation\n</span><span class=\"hljs-attr\">Resources:</span>\n  <span class=\"hljs-attr\">UserPool:</span>\n    <span class=\"hljs-attr\">Type:</span> <span class=\"hljs-string\">AWS::Cognito::UserPool</span>\n    <span class=\"hljs-attr\">Properties:</span>\n      <span class=\"hljs-attr\">UserPoolName:</span> <span class=\"hljs-string\">WeightmateUserPool</span>\n      <span class=\"hljs-attr\">AdminCreateUserConfig:</span>\n        <span class=\"hljs-attr\">AllowAdminCreateUserOnly:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">AutoVerifiedAttributes:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">email</span>\n      <span class=\"hljs-attr\">Policies:</span>\n        <span class=\"hljs-attr\">PasswordPolicy:</span>\n          <span class=\"hljs-attr\">MinimumLength:</span> <span class=\"hljs-number\">8</span>\n          <span class=\"hljs-attr\">RequireLowercase:</span> <span class=\"hljs-literal\">true</span>\n          <span class=\"hljs-attr\">RequireNumbers:</span> <span class=\"hljs-literal\">true</span>\n          <span class=\"hljs-attr\">RequireSymbols:</span> <span class=\"hljs-literal\">true</span>\n          <span class=\"hljs-attr\">RequireUppercase:</span> <span class=\"hljs-literal\">true</span>\n  <span class=\"hljs-attr\">UserPoolClient:</span>\n    <span class=\"hljs-attr\">Type:</span> <span class=\"hljs-string\">AWS::Cognito::UserPoolClient</span>\n    <span class=\"hljs-attr\">Properties:</span>\n      <span class=\"hljs-attr\">UserPoolId:</span> <span class=\"hljs-type\">!Ref</span> <span class=\"hljs-string\">UserPool</span>\n      <span class=\"hljs-attr\">ClientName:</span> <span class=\"hljs-string\">WeightmateWeb</span>\n      <span class=\"hljs-attr\">ExplicitAuthFlows:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">ALLOW_USER_SRP_AUTH</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">ALLOW_REFRESH_TOKEN_AUTH</span>\n      <span class=\"hljs-attr\">PreventUserExistenceErrors:</span> <span class=\"hljs-string\">ENABLED</span>\n\n<span class=\"hljs-attr\">Outputs:</span>\n  <span class=\"hljs-attr\">UserPoolId:</span>\n    <span class=\"hljs-attr\">Description:</span> <span class=\"hljs-string\">ID</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">User</span> <span class=\"hljs-string\">Pool</span>\n    <span class=\"hljs-attr\">Value:</span> <span class=\"hljs-type\">!Ref</span> <span class=\"hljs-string\">UserPool</span>\n  <span class=\"hljs-attr\">UserPoolClientId:</span>\n    <span class=\"hljs-attr\">Description:</span> <span class=\"hljs-string\">ID</span> <span class=\"hljs-string\">of</span> <span class=\"hljs-string\">the</span> <span class=\"hljs-string\">User</span> <span class=\"hljs-string\">Pool</span> <span class=\"hljs-string\">Client</span>\n    <span class=\"hljs-attr\">Value:</span> <span class=\"hljs-type\">!Ref</span> <span class=\"hljs-string\">UserPoolClient</span>\n</code></pre>\n<p>The outputted UserPoolId and UserPoolClientId values are what we use to integrate Cognito with Amplify.</p>\n<h2>Configuring Amplify on your frontend</h2>\n<p>Amplify is actually simple to set up, there's just two stumbling blocks:</p>\n<ol>\n<li>Amplify v6 is quite different to previous Amplify versions, so double check that you're on the right docs page and don't trust LLMs.</li>\n<li>Every example in the docs uses the Amplify CLI which obscures what is actually being added to your app.</li>\n</ol>\n<p>The <a href=\"https://docs.amplify.aws/gen1/react/tools/libraries/configure-categories/\">authentication configuration</a> near the top of this docs page is a useful resource.</p>\n<h3>Step 1: Add the aws-amplify module to your app's package.json</h3>\n<pre><code class=\"hljs language-bash\">npm install aws-amplify\n</code></pre>\n<h3>Step 2: Add your Cognito details to a .env file</h3>\n<p>Different frontend frameworks will handle handle environment variables in different ways so you'll have to consult the docs for whatever you are using. If you are still using Gatsby for some reason like I often do, then your <code class=\"inline-code-custom-style\">.env.development</code> / <code class=\"inline-code-custom-style\">.env.production</code> file would look like this (I just made these specific values up):</p>\n<pre><code class=\"hljs language-bash\">GATSBY_COGNITO_USER_POOL_ID=us-east-1_Ra7CjsEwl\nGATSBY_COGNITO_CLIENT_ID=akav9na83n2vna9n2010nvn2m2\n</code></pre>\n<h3>Step 3: Call Amplify.config in your frontend code</h3>\n<p>You need to call <code class=\"inline-code-custom-style\">Amplify.configure</code> with a configuration that includes you userPoolId, userPoolClientId, and region (from your env file). This method just needs to be called within a component early in your app's render cycle - probably something like <code class=\"inline-code-custom-style\">index.ts</code> depending on your framework.</p>\n<p>Amplify uses browser storage to hold it's auth state so technically once you have this in your code Amplify is installed on your app.</p>\n<pre><code class=\"hljs language-ts\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Amplify</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'aws-amplify'</span>;\n\n<span class=\"hljs-title class_\">Amplify</span>.<span class=\"hljs-title function_\">configure</span>({\n\t<span class=\"hljs-title class_\">Auth</span>: {\n\t\t<span class=\"hljs-title class_\">Cognito</span>: {\n\t\t\t<span class=\"hljs-attr\">userPoolId</span>: process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">USER_POOL_ID</span>,\n\t\t\t<span class=\"hljs-attr\">userPoolClientId</span>: process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">CLIENT_ID</span>,\n\t\t\t<span class=\"hljs-attr\">region</span>: process.<span class=\"hljs-property\">env</span>.<span class=\"hljs-property\">AWS_REGION</span>,\n\t\t\t<span class=\"hljs-attr\">loginWith</span>: {\n\t\t\t\t<span class=\"hljs-attr\">username</span>: <span class=\"hljs-literal\">false</span>,\n\t\t\t\t<span class=\"hljs-attr\">email</span>: <span class=\"hljs-literal\">true</span>,\n\t\t\t}\n\t\t}\n\t}\n});\n</code></pre>\n<h3>Step 4: Use the Amplify library methods to manage auth</h3>\n<p>Among other things, Amplify provides methods for logging in, logging out, signing new users up, and checking if a user is logged. Here's a very basic React app that shows the main methods being used in one big component.</p>\n<pre><code class=\"hljs language-tsx\"><span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">React</span>, { useState, useEffect } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">\"react\"</span>;\n<span class=\"hljs-keyword\">import</span> { signIn, signUp, signOut, getCurrentUser } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'aws-amplify/auth'</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">MinimalAuthAppExample</span>(<span class=\"hljs-params\"></span>) {\n\t<span class=\"hljs-keyword\">const</span> [isAuthenticated, setIsAuthenticated] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-literal\">false</span>);\n\t<span class=\"hljs-keyword\">const</span> [isLogin, setIsLogin] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-literal\">true</span>);\n\t<span class=\"hljs-keyword\">const</span> [email, setEmail] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-string\">''</span>);\n\t<span class=\"hljs-keyword\">const</span> [password, setPassword] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-string\">''</span>);\n\t<span class=\"hljs-keyword\">const</span> [confirmPassword, setConfirmPassword] = <span class=\"hljs-title function_\">useState</span>(<span class=\"hljs-string\">''</span>);\n\n\t<span class=\"hljs-title function_\">useEffect</span>(<span class=\"hljs-function\">() =></span> {\n\t\t<span class=\"hljs-title function_\">checkAuthStatus</span>();\n\t}, []);\n\n\t<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">checkAuthStatus</span> = <span class=\"hljs-keyword\">async</span> (<span class=\"hljs-params\"></span>) => {\n\t\t<span class=\"hljs-keyword\">try</span> {\n\t\t\t<span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getCurrentUser</span>();\n\t\t\t<span class=\"hljs-title function_\">setIsAuthenticated</span>(<span class=\"hljs-literal\">true</span>);\n\t\t} <span class=\"hljs-keyword\">catch</span> (error) {\n\t\t\t<span class=\"hljs-title function_\">setIsAuthenticated</span>(<span class=\"hljs-literal\">false</span>);\n\t\t}\n\t};\n\n\t<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">handleSubmit</span> = <span class=\"hljs-keyword\">async</span> (<span class=\"hljs-params\">e: React.FormEvent</span>) => {\n\t\te.<span class=\"hljs-title function_\">preventDefault</span>();\n\t\t\n\t\t<span class=\"hljs-keyword\">try</span> {\n\t\t\t<span class=\"hljs-keyword\">if</span> (isLogin) {\n\t\t\t\t<span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">signIn</span>({ <span class=\"hljs-attr\">username</span>: email, password });\n\t\t\t} <span class=\"hljs-keyword\">else</span> {\n\t\t\t\t<span class=\"hljs-keyword\">if</span> (password !== confirmPassword) {\n\t\t\t\t\t<span class=\"hljs-title function_\">alert</span>(<span class=\"hljs-string\">'Passwords do not match'</span>);\n\t\t\t\t\t<span class=\"hljs-keyword\">return</span>;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t<span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">signUp</span>({\n\t\t\t\t\t<span class=\"hljs-attr\">username</span>: email,\n\t\t\t\t\tpassword,\n\t\t\t\t\t<span class=\"hljs-attr\">options</span>: {\n\t\t\t\t\t\t<span class=\"hljs-attr\">userAttributes</span>: { email }\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t<span class=\"hljs-title function_\">setIsAuthenticated</span>(<span class=\"hljs-literal\">true</span>);\n\t\t} <span class=\"hljs-keyword\">catch</span> (err) {\n\t\t\t<span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">error</span>(<span class=\"hljs-string\">'Auth error:'</span>, err);\n\t\t\t<span class=\"hljs-title function_\">alert</span>(<span class=\"hljs-string\">\"Authentication failed\"</span>);\n\t\t}\n\t}\n\n\t<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">handleLogout</span> = <span class=\"hljs-keyword\">async</span> (<span class=\"hljs-params\"></span>) => {\n\t\t<span class=\"hljs-keyword\">try</span> {\n\t\t\t<span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">signOut</span>();\n\t\t\t<span class=\"hljs-title function_\">setIsAuthenticated</span>(<span class=\"hljs-literal\">false</span>);\n\t\t} <span class=\"hljs-keyword\">catch</span> (error) {\n\t\t\t<span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">error</span>(<span class=\"hljs-string\">'Error signing out:'</span>, error);\n\t\t}\n\t}\n\n\t<span class=\"hljs-keyword\">if</span> (isAuthenticated) {\n\t\t<span class=\"hljs-keyword\">return</span> (\n\t\t\t<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">div</span>></span>\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">p</span>></span>You are logged in!<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">p</span>></span>\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">onClick</span>=<span class=\"hljs-string\">{handleLogout}</span>></span>Logout<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">button</span>></span>\n\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">div</span>></span></span>\n\t\t);\n\t}\n\n\t<span class=\"hljs-keyword\">return</span> (\n\t\t<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">div</span>></span>\n\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">h2</span>></span>{isLogin ? 'Login' : 'Sign Up'}<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">h2</span>></span>\n\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">onClick</span>=<span class=\"hljs-string\">{()</span> =></span> setIsLogin(!isLogin)}>\n\t\t\t\tSwitch to {isLogin ? 'Sign Up' : 'Login'}\n\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">button</span>></span>\n\n\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">form</span> <span class=\"hljs-attr\">onSubmit</span>=<span class=\"hljs-string\">{handleSubmit}</span>></span>\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">div</span>></span>\n\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">label</span>></span>Email:<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">label</span>></span>\n\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">input</span>\n\t\t\t\t\t\t<span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"email\"</span>\n\t\t\t\t\t\t<span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{email}</span>\n\t\t\t\t\t\t<span class=\"hljs-attr\">onChange</span>=<span class=\"hljs-string\">{(e)</span> =></span> setEmail(e.target.value)}\n\t\t\t\t\t\trequired\n\t\t\t\t\t/>\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">div</span>></span>\n\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">div</span>></span>\n\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">label</span>></span>Password:<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">label</span>></span>\n\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">input</span>\n\t\t\t\t\t\t<span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"password\"</span>\n\t\t\t\t\t\t<span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{password}</span>\n\t\t\t\t\t\t<span class=\"hljs-attr\">onChange</span>=<span class=\"hljs-string\">{(e)</span> =></span> setPassword(e.target.value)}\n\t\t\t\t\t\trequired\n\t\t\t\t\t/>\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">div</span>></span>\n\n\t\t\t\t{!isLogin &#x26;&#x26; (\n\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">div</span>></span>\n\t\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">label</span>></span>Confirm Password:<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">label</span>></span>\n\t\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">input</span>\n\t\t\t\t\t\t\t<span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"password\"</span>\n\t\t\t\t\t\t\t<span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">{confirmPassword}</span>\n\t\t\t\t\t\t\t<span class=\"hljs-attr\">onChange</span>=<span class=\"hljs-string\">{(e)</span> =></span> setConfirmPassword(e.target.value)}\n\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t/>\n\t\t\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">div</span>></span>\n\t\t\t\t)}\n\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"submit\"</span>></span>\n\t\t\t\t\t{isLogin ? 'Login' : 'Sign Up'}\n\t\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">button</span>></span>\n\t\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">form</span>></span>\n\t\t<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">div</span>></span></span>\n\t);\n}\n</code></pre>\n<p>And that's it!</p>\n<p>I have no massive gripes with the Amplify CLI but tools like SAM or CDK are more mature and better suited to deploying more complex applications. In my case I like using SAM and I didn't want to have half my infrastructure provisioned with the Amplify CLI and the other half in SAM.</p>","title":"AWS Cognito and Amplify auth for React apps (without the Amplify CLI)","short":"Guide to simple AWS Auth for webapps with Cognito and Amplify","date":"2025-01-26","slug":"aws-webapp-auth","createdAt":"2025-01-26","img":"blog-2.jpg","tags":["Tutorial"]}},"__N_SSG":true}